name: Challenge Week 01 - Python Tests

on:
  pull_request_target:
    branches:
      - main
    paths:
      - 'challenges/week1/**/solution.py'

jobs:
  test-python:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Find Python solution file
        id: find-file
        run: |
          for file in challenges/week1/*/solution.py; do
            if [[ -f "$file" ]]; then
              echo "solution-path=$file" >> $GITHUB_OUTPUT
              break
            fi
          done

      - name: Run Python Tests
        env:
          PRIVATE_TEST_DATA: ${{ secrets.WEEK_01_PRIVATE_TESTS }}
          CHALLENGE_FILE_PATH: ${{ steps.find-file.outputs.solution-path }}
          TARGET_FUNCTION_NAME: "count_vulnerable_sections"
        run: |
          python - << 'EOF'
          import json
          import os
          import sys
          import importlib.util

          def run_challenge_tests():
              challenge_path = os.environ.get('CHALLENGE_FILE_PATH')
              if not challenge_path:
                  print('Error: CHALLENGE_FILE_PATH no proporcionado.')
                  sys.exit(1)

              target_function_name = os.environ.get('TARGET_FUNCTION_NAME')
              if not target_function_name:
                  print('Error: TARGET_FUNCTION_NAME no proporcionado.')
                  sys.exit(1)

              private_test_data_json = os.environ.get('PRIVATE_TEST_DATA')
              if not private_test_data_json:
                  print('Error: SECRETOS DE PRUEBA NO ENCONTRADOS.')
                  sys.exit(1)

              module_name = 'user_solution_module'
              spec = importlib.util.spec_from_file_location(module_name, challenge_path)
              user_solution = importlib.util.module_from_spec(spec)

              try:
                  spec.loader.exec_module(user_solution)
              except Exception as e:
                  print(f'Error al ejecutar el mÃ³dulo del usuario: {e}')
                  sys.exit(1)

              try:
                  tests = json.loads(private_test_data_json)
              except json.JSONDecodeError as e:
                  print(f'Error: PRIVATE_TEST_DATA no es JSON vÃ¡lido: {e}')
                  sys.exit(1)

              func = getattr(user_solution, target_function_name, None)
              if func is None:
                  print(f'Error: No se encontrÃ³ la funciÃ³n "{target_function_name}".')
                  sys.exit(1)

              print('--- Ejecutando Pruebas Privadas ---')
              all_passed = True

              for i, test_case in enumerate(tests):
                  try:
                      result = func(
                          test_case.get('stabilities', []),
                          test_case.get('security_threshold', 0)
                      )
                      expected = test_case.get('expected')

                      if result == expected:
                          print(f'Prueba Privada {i+1}: âœ… PASSED')
                      else:
                          print(f'Prueba Privada {i+1}: âŒ FAILED - Se esperaba {expected}, se obtuvo {result}')
                          all_passed = False
                  except Exception as e:
                      print(f'Prueba Privada {i+1}: âŒ ERROR - {e}')
                      all_passed = False

              print('----------------------------------')

              if all_passed:
                  print('Â¡Todas las pruebas privadas han pasado! ðŸŽ‰')
                  sys.exit(0)
              else:
                  print('Algunas pruebas privadas han fallado.')
                  sys.exit(1)

          run_challenge_tests()
          EOF
